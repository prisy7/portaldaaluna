<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lousa Digital de Hardware - SYSTA</title>
    
    <!-- Tratamento de Erro Global -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').innerHTML = `
                <div style="font-family:sans-serif; text-align:center; padding:50px; color:#721c24; background-color:#f8d7da;">
                    <h2>Ops! Erro ao carregar a Lousa.</h2>
                    <p>${message}</p>
                    <p style="font-size:12px; color:#555;">Verifique sua conexão com a internet para carregar o React.</p>
                </div>
            `;
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #1a202c; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .canvas-container { cursor: crosshair; touch-action: none; background-image: radial-gradient(#2d3748 1px, transparent 1px); background-size: 20px 20px; }
        .toolbar-btn { transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .toolbar-btn:hover { transform: scale(1.1); background-color: #4a5568; }
        .toolbar-btn.active { background-color: #3182ce; color: white; border-color: #63b3ed; box-shadow: 0 0 10px rgba(66, 153, 225, 0.5); }
        .toolbar-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    </style>
</head>
<body>
    <div id="root">Carregando Lousa...</div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Ícones SVG Nativos (Sem dependência externa) ---
        const IconCamera = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>;
        const IconUpload = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconMove = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="15 19 12 22 9 19"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>;
        const IconPen = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>;
        const IconTrash = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const IconZoomIn = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>;
        const IconZoomOut = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>;
        const IconUndo = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>;

        const HardwareBoard = () => {
            const [image, setImage] = useState(null);
            const [scale, setScale] = useState(1);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [tool, setTool] = useState('move'); // move, draw
            const [color, setColor] = useState('#ef4444'); // default red
            const [isDrawing, setIsDrawing] = useState(false);
            const [annotations, setAnnotations] = useState([]); // Array of {color, points, width}
            const [currentPath, setCurrentPath] = useState([]);

            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const fileInputRef = useRef(null);

            // Carregar Imagem
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            setImage(img);
                            setScale(Math.min(
                                window.innerWidth / img.width, 
                                (window.innerHeight - 100) / img.height
                            ) * 0.9); // Fit to screen
                            setPosition({ x: 0, y: 0 });
                            setAnnotations([]);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Undo function
            const undoLast = () => {
                setAnnotations(prev => prev.slice(0, -1));
            };

            // Keyboard Shortcuts (Ctrl+Z)
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        undoLast();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            // Mouse / Touch Handlers
            const getCoords = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;
                
                // Inverter a transformação (Offset - Translação) / Escala
                // Translação X = canvas.width/2 + position.x
                return {
                    x: (offsetX - (canvas.width / 2 + position.x)) / scale,
                    y: (offsetY - (canvas.height / 2 + position.y)) / scale
                };
            };

            const handleMouseDown = (e) => {
                setIsDrawing(true);
                if (tool === 'draw') {
                    setCurrentPath([getCoords(e)]);
                }
            };

            const handleMouseMove = (e) => {
                if (!isDrawing) return;

                if (tool === 'move') {
                    setPosition(prev => ({
                        x: prev.x + e.movementX,
                        y: prev.y + e.movementY
                    }));
                } else if (tool === 'draw') {
                    setCurrentPath(prev => [...prev, getCoords(e)]);
                }
            };

            const handleMouseUp = () => {
                if (tool === 'draw' && isDrawing && currentPath.length > 0) {
                    setAnnotations(prev => [...prev, { color, points: currentPath, width: 3 }]);
                    setCurrentPath([]);
                }
                setIsDrawing(false);
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                setScale(s => Math.max(0.1, Math.min(s * delta, 5)));
            };

            // Canvas Rendering Loop
            useEffect(() => {
                const canvas = canvasRef.current;
                const container = containerRef.current;
                if (!canvas || !container) return;

                const ctx = canvas.getContext('2d');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;

                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.save();
                // Apply Pan & Zoom
                ctx.translate(canvas.width / 2 + position.x, canvas.height / 2 + position.y);
                ctx.scale(scale, scale);

                // Draw Image
                if (image) {
                    ctx.drawImage(image, -image.width / 2, -image.height / 2);
                }

                // Configurar estilo de linha
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                // Desenhar anotações antigas
                annotations.forEach(ann => {
                    if (ann.points.length < 2) return;
                    ctx.beginPath();
                    ctx.strokeStyle = ann.color;
                    ctx.lineWidth = ann.width / (scale < 1 ? scale : 1);
                    ctx.lineWidth = 4 / scale; // Mantém espessura visual constante
                    ctx.moveTo(ann.points[0].x, ann.points[0].y);
                    ann.points.forEach(p => ctx.lineTo(p.x, p.y));
                    ctx.stroke();
                });

                // Desenhar traço atual
                if (currentPath.length > 1) {
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 4 / scale;
                    ctx.moveTo(currentPath[0].x, currentPath[0].y);
                    currentPath.forEach(p => ctx.lineTo(p.x, p.y));
                    ctx.stroke();
                }

                ctx.restore();

            }, [image, scale, position, annotations, currentPath]);

            return (
                <div className="flex flex-col h-screen">
                    {/* Barra de Ferramentas */}
                    <div className="bg-gray-800 p-3 shadow-md flex justify-between items-center z-10 border-b border-gray-700">
                        
                        {/* Lado Esquerdo: Upload */}
                        <div className="flex items-center gap-4">
                            <h1 className="text-lg font-bold text-blue-400 flex items-center gap-2">
                                <IconCamera size={24}/> Lousa Hardware
                            </h1>
                            <div className="h-6 w-px bg-gray-600"></div>
                            <input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImageUpload} />
                            <button onClick={() => fileInputRef.current.click()} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded flex items-center gap-2 font-bold transition">
                                <IconUpload size={18}/> Carregar Foto
                            </button>
                        </div>

                        {/* Centro: Ferramentas */}
                        <div className="flex items-center gap-3 bg-gray-900 px-4 py-2 rounded-lg">
                            <button onClick={() => setTool('move')} className={`p-2 rounded toolbar-btn ${tool === 'move' ? 'active' : 'text-gray-400'}`} title="Mover / Zoom">
                                <IconMove size={20}/>
                            </button>
                            <button onClick={() => setTool('draw')} className={`p-2 rounded toolbar-btn ${tool === 'draw' ? 'active' : 'text-gray-400'}`} title="Caneta">
                                <IconPen size={20}/>
                            </button>
                            
                            <div className="flex gap-2 ml-2 border-l border-gray-700 pl-3">
                                {['#ef4444', '#22c55e', '#3b82f6', '#eab308'].map(c => (
                                    <button 
                                        key={c}
                                        onClick={() => setColor(c)} 
                                        className={`w-6 h-6 rounded-full border-2 ${color === c ? 'border-white scale-110' : 'border-transparent'}`}
                                        style={{backgroundColor: c}}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Lado Direito: Ações */}
                        <div className="flex items-center gap-4">
                            {/* Botão Desfazer */}
                            <button 
                                onClick={undoLast} 
                                disabled={annotations.length === 0}
                                className="text-yellow-400 hover:text-yellow-300 p-2 border border-yellow-900/50 rounded hover:bg-yellow-900/20 disabled:opacity-30 disabled:cursor-not-allowed" 
                                title="Desfazer (Ctrl+Z)">
                                <IconUndo size={20}/>
                            </button>

                            <div className="flex items-center bg-gray-700 rounded px-2">
                                <button onClick={() => setScale(s => Math.max(0.1, s - 0.1))} className="p-2 text-gray-300 hover:text-white"><IconZoomOut size={18}/></button>
                                <span className="text-xs w-10 text-center">{Math.round(scale * 100)}%</span>
                                <button onClick={() => setScale(s => Math.min(5, s + 0.1))} className="p-2 text-gray-300 hover:text-white"><IconZoomIn size={18}/></button>
                            </div>
                            
                            <button onClick={() => setAnnotations([])} className="text-red-400 hover:text-red-300 p-2 border border-red-900/50 rounded hover:bg-red-900/20" title="Limpar Tudo">
                                <IconTrash size={20}/>
                            </button>
                        </div>
                    </div>

                    {/* Área da Lousa */}
                    <div 
                        ref={containerRef} 
                        className={`flex-1 relative overflow-hidden canvas-container ${tool === 'move' ? 'cursor-move' : 'cursor-crosshair'}`}
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onWheel={handleWheel}
                    >
                        {!image && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-500 pointer-events-none">
                                <IconUpload size={64} style={{opacity: 0.2}}/>
                                <p className="text-xl font-bold mt-4 text-gray-400">Arraste uma foto ou clique em Carregar</p>
                                <p className="text-sm">Suporta JPG e PNG das placas</p>
                            </div>
                        )}
                        <canvas ref={canvasRef} className="block" />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HardwareBoard />);
    </script>
</body>
</html>